<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Citadel - Security Operations Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { background: #0a0c10; overflow-x: hidden; }
  ::-webkit-scrollbar { width: 4px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.15); border-radius: 2px; }
  @keyframes threatPulse { 0%, 100% { transform: scale(1); opacity: 0.5; } 50% { transform: scale(1.3); opacity: 0; } }
  @keyframes fadeSlideIn { from { opacity: 0; transform: translateY(-8px); } to { opacity: 1; transform: translateY(0); } }
  @keyframes levelFlash { 0% { opacity: 1; } 100% { opacity: 0; } }
  button { font-family: 'JetBrains Mono', monospace; }
  button:hover { filter: brightness(1.2); }
  input { font-family: 'JetBrains Mono', monospace; }
</style>
</head>
<body>
<div id="root"></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
<script type="text/babel">
const { useState, useEffect, useCallback, useRef } = React;

const API = window.location.origin;

// Session-scoped API key (never persisted to disk)
let _apiKey = "";
function setApiKey(k) { _apiKey = k; }
function getApiKey() { return _apiKey; }

async function api(path, opts) {
  const headers = { "Content-Type": "application/json" };
  if (_apiKey) headers["Authorization"] = "Bearer " + _apiKey;
  const res = await fetch(API + path, { headers, ...opts });
  if (res.status === 401) throw new Error("AUTH");
  if (res.status === 403) throw new Error("FORBIDDEN");
  if (res.status === 429) throw new Error("RATE_LIMITED");
  return res.json();
}

const THREAT_CONFIGS = {
  1: { name: "LOW", color: "#22c55e", bg: "rgba(34,197,94,0.08)", glow: "0 0 40px rgba(34,197,94,0.3)" },
  2: { name: "GUARDED", color: "#3b82f6", bg: "rgba(59,130,246,0.08)", glow: "0 0 40px rgba(59,130,246,0.3)" },
  3: { name: "ELEVATED", color: "#eab308", bg: "rgba(234,179,8,0.08)", glow: "0 0 40px rgba(234,179,8,0.3)" },
  4: { name: "HIGH", color: "#f97316", bg: "rgba(249,115,22,0.08)", glow: "0 0 40px rgba(249,115,22,0.3)" },
  5: { name: "CRITICAL", color: "#ef4444", bg: "rgba(239,68,68,0.08)", glow: "0 0 40px rgba(239,68,68,0.3)" },
};

const EVENT_KINDS = [
  { kind: "DecryptionFailure", label: "Decryption Failure", severity: 3.0, icon: "\u2715" },
  { kind: "RapidAccessPattern", label: "Rapid Access", severity: 4.0, icon: "\u26A1" },
  { kind: "AnomalousAccess", label: "Anomalous Access", severity: 5.0, icon: "\u26A0" },
  { kind: "ExternalAdvisory", label: "External Advisory", severity: 8.0, icon: "\uD83D\uDCE1" },
  { kind: "AuthFailure", label: "Auth Failure", severity: 3.5, icon: "\uD83D\uDD12" },
  { kind: "KeyEnumeration", label: "Key Enumeration", severity: 6.0, icon: "\uD83D\uDD0D" },
];

const SCOPE_COLORS = {
  admin: "#ef4444",
  manage: "#f97316",
  encrypt: "#eab308",
  read: "#22c55e",
};

function RadialGauge({ value, max = 100, color, label, size = 110 }) {
  const r = (size - 12) / 2;
  const c = 2 * Math.PI * r;
  const offset = c * (1 - (value / max) * 0.75);
  return (
    <div style={{ textAlign: "center", width: size }}>
      <svg width={size} height={size} viewBox={"0 0 " + size + " " + size}>
        <circle cx={size/2} cy={size/2} r={r} fill="none" stroke="rgba(255,255,255,0.06)" strokeWidth="6"
          strokeDasharray={c*0.75 + " " + c*0.25} strokeLinecap="round"
          transform={"rotate(135 "+size/2+" "+size/2+")"} />
        <circle cx={size/2} cy={size/2} r={r} fill="none" stroke={color} strokeWidth="6"
          strokeDasharray={c*0.75 + " " + c*0.25} strokeDashoffset={offset}
          strokeLinecap="round" transform={"rotate(135 "+size/2+" "+size/2+")"}
          style={{ transition: "stroke-dashoffset 0.8s cubic-bezier(0.4,0,0.2,1), stroke 0.4s ease" }} />
        <text x={size/2} y={size/2-4} textAnchor="middle" fill="white" fontSize="20" fontWeight="700"
          fontFamily="'JetBrains Mono', monospace">{value.toFixed(1)}</text>
        <text x={size/2} y={size/2+14} textAnchor="middle" fill="rgba(255,255,255,0.45)" fontSize="8"
          fontFamily="'JetBrains Mono', monospace" letterSpacing="1">{label}</text>
      </svg>
    </div>
  );
}

function ThreatHex({ level, config, pulse }) {
  const s = 140;
  const pts = Array.from({length:6},(_,i)=>{const a=Math.PI/3*i-Math.PI/2;return[s/2+54*Math.cos(a),s/2+54*Math.sin(a)].join(",");}).join(" ");
  return (
    <div style={{ position:"relative", width:s, height:s }}>
      {pulse && <div style={{ position:"absolute", inset:0, display:"flex", alignItems:"center", justifyContent:"center" }}>
        <div style={{ width:100, height:100, borderRadius:"50%", border:"2px solid "+config.color+"30", animation:"threatPulse 2s ease-in-out infinite" }} />
      </div>}
      <svg width={s} height={s} viewBox={"0 0 "+s+" "+s}>
        <polygon points={pts} fill={config.bg} stroke={config.color} strokeWidth="2" opacity="0.6" />
        <text x={s/2} y={s/2-8} textAnchor="middle" fill={config.color} fontSize="36" fontWeight="800"
          fontFamily="'JetBrains Mono',monospace">{level}</text>
        <text x={s/2} y={s/2+16} textAnchor="middle" fill={config.color} fontSize="11" fontWeight="600"
          fontFamily="'JetBrains Mono',monospace" letterSpacing="3">{config.name}</text>
      </svg>
    </div>
  );
}

// ---- Login Screen ----

function LoginScreen({ onLogin }) {
  const [key, setKey] = useState("");
  const [error, setError] = useState("");
  const [loading, setLoading] = useState(false);
  const [devMode, setDevMode] = useState(false);

  useEffect(() => {
    // Check if auth is disabled (dev mode)
    fetch(API + "/api/status", { headers: { "Content-Type": "application/json" } })
      .then(r => { if (r.ok) { setDevMode(true); } })
      .catch(() => {});
  }, []);

  const tryLogin = async () => {
    setLoading(true);
    setError("");
    try {
      setApiKey(key);
      const res = await api("/api/auth/whoami");
      if (res.key_id) {
        onLogin({ keyId: res.key_id, keyName: res.key_name, scopes: res.scopes });
      } else {
        throw new Error("AUTH");
      }
    } catch(e) {
      setApiKey("");
      if (e.message === "AUTH") {
        setError("Invalid API key");
      } else {
        setError("Connection failed");
      }
    }
    setLoading(false);
  };

  const enterDevMode = () => {
    setApiKey("");
    onLogin({ keyId: "dev", keyName: "dev-mode", scopes: ["admin"] });
  };

  return (
    <div style={{ minHeight:"100vh", background:"#0a0c10", display:"flex", alignItems:"center", justifyContent:"center",
      fontFamily:"'JetBrains Mono',monospace" }}>
      <div style={{ width:380, padding:40, background:"rgba(255,255,255,0.02)", border:"1px solid rgba(255,255,255,0.08)",
        borderRadius:16, textAlign:"center" }}>
        <div style={{ fontSize:40, marginBottom:8 }}>{"\uD83C\uDFF0"}</div>
        <div style={{ fontSize:18, fontWeight:700, color:"#fff", letterSpacing:3, marginBottom:4 }}>CITADEL</div>
        <div style={{ fontSize:9, letterSpacing:4, color:"rgba(255,255,255,0.3)", marginBottom:32 }}>SECURITY OPERATIONS</div>

        <div style={{ textAlign:"left", marginBottom:6 }}>
          <label style={{ fontSize:10, letterSpacing:2, color:"rgba(255,255,255,0.4)" }}>API KEY</label>
        </div>
        <input
          type="password"
          value={key}
          onChange={e => setKey(e.target.value)}
          onKeyDown={e => { if (e.key === "Enter" && key) tryLogin(); }}
          placeholder="Enter your API key..."
          style={{ width:"100%", padding:"10px 14px", fontSize:12, background:"rgba(255,255,255,0.04)",
            border:"1px solid rgba(255,255,255,0.1)", borderRadius:6, color:"#fff", outline:"none",
            marginBottom:12 }}
        />

        {error && <div style={{ fontSize:11, color:"#ef4444", marginBottom:12 }}>{error}</div>}

        <button onClick={tryLogin} disabled={!key || loading}
          style={{ width:"100%", padding:"10px 0", fontSize:11, fontWeight:600, letterSpacing:2,
            background: key ? "rgba(59,130,246,0.15)" : "rgba(255,255,255,0.03)",
            border: key ? "1px solid rgba(59,130,246,0.4)" : "1px solid rgba(255,255,255,0.08)",
            color: key ? "#3b82f6" : "rgba(255,255,255,0.3)",
            borderRadius:6, cursor: key ? "pointer" : "default", marginBottom:8 }}>
          {loading ? "AUTHENTICATING..." : "AUTHENTICATE"}
        </button>

        {devMode && (
          <button onClick={enterDevMode}
            style={{ width:"100%", padding:"8px 0", fontSize:10, fontWeight:500, letterSpacing:1,
              background:"transparent", border:"1px solid rgba(255,255,255,0.06)",
              color:"rgba(255,255,255,0.25)", borderRadius:6, cursor:"pointer", marginTop:4 }}>
            CONTINUE WITHOUT AUTH (DEV MODE)
          </button>
        )}

        <div style={{ marginTop:24, fontSize:9, color:"rgba(255,255,255,0.15)", lineHeight:1.6 }}>
          v0.2.0 | X25519 + ML-KEM-768 + AES-256-GCM
        </div>
      </div>
    </div>
  );
}

// ---- API Key Management Panel ----

function ApiKeyPanel({ authInfo, config }) {
  const [apiKeys, setApiKeys] = useState([]);
  const [showCreate, setShowCreate] = useState(false);
  const [newName, setNewName] = useState("");
  const [newScopes, setNewScopes] = useState(["read"]);
  const [createdKey, setCreatedKey] = useState(null);
  const [error, setError] = useState("");
  const isAdmin = authInfo.scopes.includes("admin");

  const loadKeys = async () => {
    try {
      const data = await api("/api/auth/keys");
      if (Array.isArray(data)) setApiKeys(data);
    } catch(e) {}
  };

  useEffect(() => { if (isAdmin) loadKeys(); }, [isAdmin]);

  const createKey = async () => {
    setError("");
    if (!newName.trim()) { setError("Name required"); return; }
    try {
      const res = await api("/api/auth/keys", {
        method: "POST",
        body: JSON.stringify({ name: newName.trim(), scopes: newScopes }),
      });
      if (res.api_key) {
        setCreatedKey(res);
        setNewName("");
        setNewScopes(["read"]);
        loadKeys();
      } else if (res.error) {
        setError(res.error);
      }
    } catch(e) { setError("Failed to create key"); }
  };

  const revokeKey = async (id) => {
    try {
      const res = await api("/api/auth/keys/" + id, { method: "DELETE" });
      if (res.error) { setError(res.error); }
      else { setError(""); loadKeys(); }
    } catch(e) { setError("Failed to revoke key"); }
  };

  const toggleScope = (scope) => {
    setNewScopes(prev => prev.includes(scope) ? prev.filter(s => s !== scope) : [...prev, scope]);
  };

  const copyKey = (text) => {
    navigator.clipboard.writeText(text).catch(() => {});
  };

  if (!isAdmin) {
    return (
      <div style={{ background:"rgba(255,255,255,0.02)", border:"1px solid rgba(255,255,255,0.06)",
        borderRadius:12, padding:24, textAlign:"center" }}>
        <div style={{ fontSize:9, letterSpacing:3, color:"rgba(255,255,255,0.35)", marginBottom:12 }}>API KEY MANAGEMENT</div>
        <div style={{ color:"rgba(255,255,255,0.25)", fontSize:11 }}>
          Admin scope required to manage API keys.
        </div>
        <div style={{ marginTop:12, fontSize:10, color:"rgba(255,255,255,0.15)" }}>
          Authenticated as: {authInfo.keyName} ({authInfo.scopes.join(", ")})
        </div>
      </div>
    );
  }

  return (
    <div style={{ background:"rgba(255,255,255,0.02)", border:"1px solid rgba(255,255,255,0.06)",
      borderRadius:12, padding:24 }}>
      <div style={{ display:"flex", justifyContent:"space-between", alignItems:"center", marginBottom:16 }}>
        <div style={{ fontSize:9, letterSpacing:3, color:"rgba(255,255,255,0.35)" }}>
          API KEY MANAGEMENT ({apiKeys.length})
        </div>
        <button onClick={() => { setShowCreate(!showCreate); setCreatedKey(null); setError(""); }}
          style={{ padding:"4px 10px", fontSize:9, fontWeight:600, letterSpacing:1,
            background: showCreate ? "rgba(239,68,68,0.1)" : "rgba(59,130,246,0.1)",
            border: showCreate ? "1px solid rgba(239,68,68,0.3)" : "1px solid rgba(59,130,246,0.3)",
            color: showCreate ? "#ef4444" : "#3b82f6", borderRadius:4, cursor:"pointer" }}>
          {showCreate ? "\u2715 CANCEL" : "+ NEW KEY"}
        </button>
      </div>

      {error && <div style={{ fontSize:10, color:"#ef4444", marginBottom:8, padding:"6px 10px",
        background:"rgba(239,68,68,0.08)", borderRadius:4 }}>{error}</div>}

      {/* Created key banner */}
      {createdKey && (
        <div style={{ marginBottom:12, padding:12, borderRadius:8,
          background:"rgba(34,197,94,0.08)", border:"1px solid rgba(34,197,94,0.3)" }}>
          <div style={{ fontSize:10, fontWeight:600, color:"#22c55e", marginBottom:8 }}>
            KEY CREATED - COPY NOW (shown only once)
          </div>
          <div style={{ display:"flex", alignItems:"center", gap:8 }}>
            <code style={{ flex:1, fontSize:10, color:"#fff", background:"rgba(0,0,0,0.3)",
              padding:"6px 10px", borderRadius:4, wordBreak:"break-all" }}>
              {createdKey.api_key}
            </code>
            <button onClick={() => copyKey(createdKey.api_key)}
              style={{ padding:"6px 10px", fontSize:9, fontWeight:600,
                background:"rgba(34,197,94,0.15)", border:"1px solid rgba(34,197,94,0.4)",
                color:"#22c55e", borderRadius:4, cursor:"pointer", whiteSpace:"nowrap" }}>
              COPY
            </button>
          </div>
          <div style={{ fontSize:9, color:"rgba(255,255,255,0.4)", marginTop:6 }}>
            ID: {createdKey.key_id} | Name: {createdKey.name} | Scopes: {(createdKey.scopes||[]).join(", ")}
          </div>
        </div>
      )}

      {/* Create form */}
      {showCreate && !createdKey && (
        <div style={{ marginBottom:12, padding:12, borderRadius:8,
          background:"rgba(59,130,246,0.04)", border:"1px solid rgba(59,130,246,0.15)" }}>
          <div style={{ marginBottom:8 }}>
            <label style={{ fontSize:9, letterSpacing:1, color:"rgba(255,255,255,0.4)" }}>KEY NAME</label>
            <input value={newName} onChange={e => setNewName(e.target.value)}
              onKeyDown={e => { if (e.key === "Enter") createKey(); }}
              placeholder="e.g. monitoring, app-service"
              style={{ width:"100%", padding:"6px 10px", fontSize:11, marginTop:4,
                background:"rgba(255,255,255,0.04)", border:"1px solid rgba(255,255,255,0.1)",
                borderRadius:4, color:"#fff", outline:"none" }} />
          </div>
          <div style={{ marginBottom:10 }}>
            <label style={{ fontSize:9, letterSpacing:1, color:"rgba(255,255,255,0.4)" }}>SCOPES</label>
            <div style={{ display:"flex", gap:6, marginTop:6 }}>
              {["read", "encrypt", "manage", "admin"].map(scope => (
                <button key={scope} onClick={() => toggleScope(scope)}
                  style={{ padding:"4px 10px", fontSize:9, fontWeight:600, letterSpacing:1,
                    background: newScopes.includes(scope) ? (SCOPE_COLORS[scope]||"#fff") + "20" : "rgba(255,255,255,0.03)",
                    border: "1px solid " + (newScopes.includes(scope) ? (SCOPE_COLORS[scope]||"#fff") + "50" : "rgba(255,255,255,0.08)"),
                    color: newScopes.includes(scope) ? (SCOPE_COLORS[scope]||"#fff") : "rgba(255,255,255,0.3)",
                    borderRadius:4, cursor:"pointer" }}>
                  {scope.toUpperCase()}
                </button>
              ))}
            </div>
          </div>
          <button onClick={createKey} disabled={!newName.trim() || newScopes.length === 0}
            style={{ padding:"6px 16px", fontSize:10, fontWeight:600, letterSpacing:1,
              background:"rgba(59,130,246,0.15)", border:"1px solid rgba(59,130,246,0.4)",
              color:"#3b82f6", borderRadius:4, cursor:"pointer" }}>
            CREATE KEY
          </button>
        </div>
      )}

      {/* Key list */}
      <div style={{ maxHeight:280, overflowY:"auto" }}>
        {apiKeys.map(k => (
          <div key={k.key_id} style={{ padding:"8px 12px", marginBottom:3, borderRadius:6,
            background: k.key_id === authInfo.keyId ? "rgba(59,130,246,0.06)" : "rgba(255,255,255,0.02)",
            border: k.key_id === authInfo.keyId ? "1px solid rgba(59,130,246,0.15)" : "1px solid rgba(255,255,255,0.04)",
            display:"flex", alignItems:"center", gap:10, fontSize:11 }}>
            <div style={{ flex:1 }}>
              <div style={{ display:"flex", alignItems:"center", gap:6 }}>
                <span style={{ fontWeight:600, color:"#fff", fontSize:11 }}>{k.key_name}</span>
                {k.key_id === authInfo.keyId && (
                  <span style={{ fontSize:8, padding:"1px 5px", borderRadius:3,
                    background:"rgba(59,130,246,0.2)", color:"#60a5fa" }}>YOU</span>
                )}
                {!k.active && (
                  <span style={{ fontSize:8, padding:"1px 5px", borderRadius:3,
                    background:"rgba(239,68,68,0.2)", color:"#ef4444" }}>REVOKED</span>
                )}
              </div>
              <div style={{ color:"rgba(255,255,255,0.3)", fontSize:9, marginTop:2 }}>
                {k.key_id}
                {k.last_used ? " | last used: " + new Date(k.last_used).toLocaleString() : " | never used"}
              </div>
            </div>
            <div style={{ display:"flex", gap:3, flexWrap:"wrap" }}>
              {(k.scopes || []).map(s => (
                <span key={s} style={{ fontSize:8, padding:"2px 6px", borderRadius:3, fontWeight:600, letterSpacing:1,
                  background:(SCOPE_COLORS[s]||"#6b7280")+"15", color:SCOPE_COLORS[s]||"#6b7280",
                  border:"1px solid "+(SCOPE_COLORS[s]||"#6b7280")+"25" }}>
                  {s.toUpperCase()}
                </span>
              ))}
            </div>
            {k.active && k.key_id !== authInfo.keyId && (
              <button onClick={() => revokeKey(k.key_id)}
                style={{ padding:"3px 8px", fontSize:8, fontWeight:600, letterSpacing:1,
                  background:"rgba(239,68,68,0.08)", border:"1px solid rgba(239,68,68,0.2)",
                  color:"#ef4444", borderRadius:3, cursor:"pointer", whiteSpace:"nowrap" }}>
                REVOKE
              </button>
            )}
          </div>
        ))}
      </div>
    </div>
  );
}

// ---- Main Dashboard ----

function CitadelDashboard() {
  const [authInfo, setAuthInfo] = useState(null);
  const [status, setStatus] = useState({ threat_level:1, threat_name:"LOW", threat_color:"#22c55e", threat_score:0, total_keys:0, active_keys:0 });
  const [metrics, setMetrics] = useState(null);
  const [keys, setKeys] = useState([]);
  const [policies, setPolicies] = useState([]);
  const [events, setEvents] = useState([]);
  const [flashLevel, setFlashLevel] = useState(false);
  const [connected, setConnected] = useState(false);
  const [tab, setTab] = useState("ops");
  const prevLevel = useRef(1);

  const refresh = useCallback(async () => {
    try {
      const [s, m, k, p] = await Promise.all([
        api("/api/status"), api("/api/metrics"), api("/api/keys"), api("/api/policies"),
      ]);
      if (s.threat_level !== prevLevel.current) {
        setFlashLevel(true);
        setTimeout(() => setFlashLevel(false), 1500);
        prevLevel.current = s.threat_level;
      }
      setStatus(s); setMetrics(m); setKeys(k); setPolicies(p);
      setConnected(true);
    } catch(e) {
      if (e.message === "AUTH") { setAuthInfo(null); setApiKey(""); }
      else { setConnected(false); }
    }
  }, []);

  useEffect(() => {
    if (!authInfo) return;
    refresh();
    const iv = setInterval(refresh, 1500);
    return () => clearInterval(iv);
  }, [refresh, authInfo]);

  const injectEvent = async (kind, severity) => {
    const result = await api("/api/threat/event", {
      method: "POST",
      body: JSON.stringify({ kind, severity }),
    });
    const ek = EVENT_KINDS.find(e => e.kind === kind);
    setEvents(prev => [{ id: Date.now()+Math.random(), label: ek?.label||kind, icon: ek?.icon||"?",
      severity, time: new Date().toLocaleTimeString(),
      resultLevel: result.name, resultScore: result.score,
    }, ...prev].slice(0, 50));
    refresh();
  };

  const resetThreats = async () => {
    await api("/api/threat/reset", { method: "POST" });
    setEvents([]);
    refresh();
  };

  const generateKey = async () => {
    const result = await api("/api/keys", {
      method: "POST",
      body: JSON.stringify({ name: "new-dek-" + Date.now().toString(36), key_type: "dek", policy_id: "default-dek" }),
    });
    if (result.key_id) {
      await api("/api/keys/" + result.key_id + "/activate", { method: "POST" });
    }
    refresh();
  };

  const rotateKey = async (id) => {
    await api("/api/keys/" + id + "/rotate", { method: "POST" });
    refresh();
  };

  const logout = () => {
    setApiKey("");
    setAuthInfo(null);
    setConnected(false);
  };

  if (!authInfo) {
    return <LoginScreen onLogin={setAuthInfo} />;
  }

  const lv = status.threat_level || 1;
  const config = THREAT_CONFIGS[lv] || THREAT_CONFIGS[1];
  const stateColor = (s) => ({Active:"#22c55e",Rotated:"#eab308",Pending:"#3b82f6",Revoked:"#f97316",Destroyed:"#6b7280"}[s]||"#6b7280");

  return (
    <div style={{ minHeight:"100vh", background:"#0a0c10", color:"#e2e8f0",
      fontFamily:"'JetBrains Mono','Fira Code',monospace", position:"relative", overflow:"hidden" }}>

      {/* Overlays */}
      <div style={{ position:"fixed", inset:0, pointerEvents:"none", zIndex:100,
        background:"repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,0,0,0.03) 2px, rgba(0,0,0,0.03) 4px)" }} />
      <div style={{ position:"fixed", inset:0, pointerEvents:"none", opacity:0.03,
        backgroundImage:"linear-gradient(rgba(255,255,255,0.1) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.1) 1px, transparent 1px)",
        backgroundSize:"40px 40px" }} />
      {flashLevel && <div style={{ position:"fixed", inset:0, zIndex:90, pointerEvents:"none",
        background:"radial-gradient(ellipse at center, "+config.color+"15, transparent 70%)",
        animation:"levelFlash 1.5s ease-out forwards" }} />}

      {/* Header */}
      <header style={{ padding:"16px 24px", display:"flex", alignItems:"center", justifyContent:"space-between",
        borderBottom:"1px solid rgba(255,255,255,0.06)", backdropFilter:"blur(12px)",
        background:"rgba(10,12,16,0.8)", position:"sticky", top:0, zIndex:50 }}>
        <div style={{ display:"flex", alignItems:"center", gap:12 }}>
          <div style={{ width:32, height:32, borderRadius:6, display:"flex", alignItems:"center", justifyContent:"center",
            background:"linear-gradient(135deg, "+config.color+"30, "+config.color+"10)",
            border:"1px solid "+config.color+"40", transition:"all 0.4s ease" }}>
            <span style={{ fontSize:16 }}>{"\uD83C\uDFF0"}</span>
          </div>
          <div>
            <div style={{ fontSize:14, fontWeight:700, letterSpacing:2, color:"#fff" }}>CITADEL</div>
            <div style={{ fontSize:9, letterSpacing:3, color:"rgba(255,255,255,0.35)", marginTop:-2 }}>SECURITY OPERATIONS</div>
          </div>
        </div>
        <div style={{ display:"flex", alignItems:"center", gap:8 }}>
          {/* Tabs */}
          {["ops", "keys"].map(t => (
            <button key={t} onClick={() => setTab(t)}
              style={{ padding:"4px 12px", fontSize:9, fontWeight:600, letterSpacing:1,
                background: tab === t ? "rgba(255,255,255,0.08)" : "transparent",
                border: tab === t ? "1px solid rgba(255,255,255,0.12)" : "1px solid transparent",
                color: tab === t ? "#fff" : "rgba(255,255,255,0.35)",
                borderRadius:4, cursor:"pointer" }}>
              {t === "ops" ? "OPERATIONS" : "API KEYS"}
            </button>
          ))}
          <div style={{ width:1, height:16, background:"rgba(255,255,255,0.08)", margin:"0 4px" }} />
          <div style={{ width:8, height:8, borderRadius:"50%", background: connected?"#22c55e":"#ef4444",
            boxShadow: connected?"0 0 8px #22c55e":"0 0 8px #ef4444" }} />
          <div style={{ fontSize:10, color:"rgba(255,255,255,0.3)", letterSpacing:1 }}>
            {connected ? "LIVE" : "DISCONNECTED"}
          </div>
          <div style={{ fontSize:10, color:"rgba(255,255,255,0.25)", letterSpacing:1 }}>
            X25519 + ML-KEM-768
          </div>
          <div style={{ padding:"4px 10px", borderRadius:4, fontSize:10, fontWeight:600, letterSpacing:1,
            background:config.bg, color:config.color, border:"1px solid "+config.color+"30", transition:"all 0.4s ease" }}>
            DEFCON {6-lv}
          </div>
          <div style={{ width:1, height:16, background:"rgba(255,255,255,0.08)", margin:"0 4px" }} />
          {/* Auth info + logout */}
          <div style={{ fontSize:9, color:"rgba(255,255,255,0.3)" }}>
            {authInfo.keyName}
          </div>
          <button onClick={logout}
            style={{ padding:"3px 8px", fontSize:8, fontWeight:600, letterSpacing:1,
              background:"rgba(239,68,68,0.08)", border:"1px solid rgba(239,68,68,0.15)",
              color:"#ef4444", borderRadius:3, cursor:"pointer" }}>
            LOGOUT
          </button>
        </div>
      </header>

      <div style={{ padding:"20px 24px", maxWidth:1400, margin:"0 auto" }}>

        {/* === API KEYS TAB === */}
        {tab === "keys" && (
          <div>
            {/* Auth info card */}
            <div style={{ background:"rgba(255,255,255,0.02)", border:"1px solid rgba(255,255,255,0.06)",
              borderRadius:12, padding:20, marginBottom:20, display:"flex", alignItems:"center", gap:16 }}>
              <div style={{ width:40, height:40, borderRadius:8, display:"flex", alignItems:"center", justifyContent:"center",
                background:"rgba(59,130,246,0.1)", border:"1px solid rgba(59,130,246,0.2)" }}>
                <span style={{ fontSize:18 }}>{"\uD83D\uDD11"}</span>
              </div>
              <div style={{ flex:1 }}>
                <div style={{ fontSize:12, fontWeight:600, color:"#fff" }}>Authenticated as: {authInfo.keyName}</div>
                <div style={{ fontSize:10, color:"rgba(255,255,255,0.4)", marginTop:2 }}>
                  Key ID: {authInfo.keyId}
                </div>
              </div>
              <div style={{ display:"flex", gap:4 }}>
                {authInfo.scopes.map(s => (
                  <span key={s} style={{ fontSize:9, padding:"3px 8px", borderRadius:4, fontWeight:600, letterSpacing:1,
                    background:(SCOPE_COLORS[s]||"#6b7280")+"15", color:SCOPE_COLORS[s]||"#6b7280",
                    border:"1px solid "+(SCOPE_COLORS[s]||"#6b7280")+"30" }}>
                    {s.toUpperCase()}
                  </span>
                ))}
              </div>
            </div>

            <ApiKeyPanel authInfo={authInfo} config={config} />
          </div>
        )}

        {/* === OPERATIONS TAB === */}
        {tab === "ops" && (<>

        {/* Top Row */}
        <div style={{ display:"grid", gridTemplateColumns:"300px 1fr", gap:20, marginBottom:20 }}>

          {/* Threat Card */}
          <div style={{ background:"rgba(255,255,255,0.02)", border:"1px solid rgba(255,255,255,0.06)",
            borderRadius:12, padding:24, display:"flex", flexDirection:"column", alignItems:"center",
            position:"relative", overflow:"hidden" }}>
            <div style={{ position:"absolute", top:0, left:0, right:0, height:2,
              background:"linear-gradient(90deg, transparent, "+config.color+", transparent)",
              transition:"background 0.4s ease" }} />
            <div style={{ fontSize:9, letterSpacing:3, color:"rgba(255,255,255,0.35)", marginBottom:16 }}>THREAT ASSESSMENT</div>
            <ThreatHex level={lv} config={config} pulse={lv >= 3} />
            <div style={{ marginTop:16, width:"100%", height:4, borderRadius:2, background:"rgba(255,255,255,0.06)",
              position:"relative", overflow:"hidden" }}>
              <div style={{ position:"absolute", left:0, top:0, bottom:0, borderRadius:2,
                width: Math.min(100, (status.threat_score/60)*100)+"%",
                background:"linear-gradient(90deg, "+config.color+"80, "+config.color+")",
                transition:"width 0.6s ease, background 0.4s ease" }} />
            </div>
            <div style={{ fontSize:10, color:"rgba(255,255,255,0.3)", marginTop:8 }}>
              SCORE: <span style={{ color:config.color, fontWeight:600 }}>{(status.threat_score||0).toFixed(1)}</span>
              <span style={{ marginLeft:12 }}>KEYS: {status.total_keys} ({status.active_keys} active)</span>
            </div>
            <div style={{ marginTop:16, width:"100%", display:"flex", gap:6 }}>
              <button onClick={resetThreats} style={{ flex:1, padding:"6px 0", fontSize:9, fontWeight:600, letterSpacing:1,
                background:"rgba(34,197,94,0.1)", border:"1px solid rgba(34,197,94,0.3)",
                color:"#22c55e", borderRadius:4, cursor:"pointer" }}>{"\u2193"} RESET</button>
              <button onClick={() => injectEvent("ExternalAdvisory", 8.0)} style={{ flex:1, padding:"6px 0", fontSize:9, fontWeight:600, letterSpacing:1,
                background:"rgba(239,68,68,0.1)", border:"1px solid rgba(239,68,68,0.3)",
                color:"#ef4444", borderRadius:4, cursor:"pointer" }}>{"\u2191"} ESCALATE</button>
            </div>
          </div>

          {/* Security Metrics */}
          <div style={{ background:"rgba(255,255,255,0.02)", border:"1px solid rgba(255,255,255,0.06)",
            borderRadius:12, padding:24 }}>
            <div style={{ display:"flex", justifyContent:"space-between", alignItems:"center", marginBottom:20 }}>
              <div style={{ fontSize:9, letterSpacing:3, color:"rgba(255,255,255,0.35)" }}>SECURITY POSTURE</div>
              {metrics && <div style={{ fontSize:28, fontWeight:800, color:config.color, transition:"color 0.4s ease" }}>
                {metrics.overall.toFixed(1)}
                <span style={{ fontSize:12, fontWeight:400, color:"rgba(255,255,255,0.3)", marginLeft:4 }}>/100</span>
              </div>}
            </div>
            {metrics && <div style={{ display:"grid", gridTemplateColumns:"repeat(5, 1fr)", gap:8 }}>
              {[
                { label:"QUANTUM", value:metrics.quantum_resistance, color:"#a78bfa" },
                { label:"CLASSICAL", value:metrics.classical_security, color:"#60a5fa" },
                { label:"SIDE-CH", value:metrics.side_channel_resistance, color:"#34d399" },
                { label:"ADAPTIVE", value:metrics.adaptive_defense, color:config.color },
                { label:"HYGIENE", value:metrics.key_hygiene, color:"#f472b6" },
              ].map((m,i) => <RadialGauge key={i} value={m.value} color={m.color} label={m.label} />)}
            </div>}
          </div>
        </div>

        {/* Policy Adaptation Table */}
        <div style={{ background:"rgba(255,255,255,0.02)", border:"1px solid rgba(255,255,255,0.06)",
          borderRadius:12, padding:24, marginBottom:20 }}>
          <div style={{ display:"flex", justifyContent:"space-between", alignItems:"center", marginBottom:16 }}>
            <div style={{ fontSize:9, letterSpacing:3, color:"rgba(255,255,255,0.35)" }}>ADAPTIVE POLICY ENGINE</div>
            <div style={{ padding:"3px 8px", borderRadius:3, fontSize:9, fontWeight:600,
              background:config.bg, color:config.color, border:"1px solid "+config.color+"20" }}>
              {lv >= 3 ? "AUTO-ROTATE FORCED" : "NORMAL OPS"}
            </div>
          </div>
          <div style={{ overflowX:"auto" }}>
            <table style={{ width:"100%", borderCollapse:"collapse", fontSize:12 }}>
              <thead>
                <tr style={{ borderBottom:"1px solid rgba(255,255,255,0.08)" }}>
                  {["POLICY","PARAMETER","BASE","EFFECTIVE","CHANGE"].map(h =>
                    <th key={h} style={{ padding:"8px 12px", textAlign:"left", fontSize:9, letterSpacing:2, color:"rgba(255,255,255,0.3)", fontWeight:500 }}>{h}</th>
                  )}
                </tr>
              </thead>
              <tbody>
                {policies.flatMap((pol, pi) => {
                  const rows = [
                    { p:"Rotation Age", base: pol.base_rotation_age_days != null ? pol.base_rotation_age_days.toFixed(0)+"d" : "\u221E",
                      eff: pol.effective_rotation_age_days != null ? pol.effective_rotation_age_days.toFixed(0)+"d" : "\u221E",
                      changed: pol.base_rotation_age_days != null && pol.effective_rotation_age_days < pol.base_rotation_age_days,
                      pct: pol.base_rotation_age_days ? Math.round((1 - pol.effective_rotation_age_days / pol.base_rotation_age_days)*100) : 0 },
                    { p:"Grace Period", base: pol.base_grace_period_days.toFixed(0)+"d", eff: pol.effective_grace_period_days.toFixed(1)+"d",
                      changed: pol.effective_grace_period_days < pol.base_grace_period_days,
                      pct: Math.round((1 - pol.effective_grace_period_days / pol.base_grace_period_days)*100) },
                    { p:"Max Lifetime", base: pol.base_max_lifetime_days != null ? pol.base_max_lifetime_days.toFixed(0)+"d" : "\u221E",
                      eff: pol.effective_max_lifetime_days != null ? pol.effective_max_lifetime_days.toFixed(0)+"d" : "\u221E",
                      changed: pol.base_max_lifetime_days != null && pol.effective_max_lifetime_days < pol.base_max_lifetime_days,
                      pct: pol.base_max_lifetime_days ? Math.round((1 - pol.effective_max_lifetime_days / pol.base_max_lifetime_days)*100) : 0 },
                    { p:"Usage Limit", base: pol.base_usage_limit != null ? pol.base_usage_limit.toLocaleString() : "\u221E",
                      eff: pol.effective_usage_limit != null ? pol.effective_usage_limit.toLocaleString() : "\u221E",
                      changed: pol.base_usage_limit != null && pol.effective_usage_limit < pol.base_usage_limit,
                      pct: pol.base_usage_limit ? Math.round((1 - pol.effective_usage_limit / pol.base_usage_limit)*100) : 0 },
                  ];
                  if (pol.auto_rotate_forced) rows.push({ p:"Auto-Rotate", base:"OFF", eff:"FORCED ON", changed:true, pct:null });
                  return rows.map((row, ri) => (
                    <tr key={pi+"-"+ri} style={{ borderBottom:"1px solid rgba(255,255,255,0.04)" }}>
                      {ri===0 ? <td rowSpan={rows.length} style={{ padding:"8px 12px", fontWeight:600, color:"#fff", verticalAlign:"top",
                        borderRight:"1px solid rgba(255,255,255,0.06)" }}>{pol.policy_name}</td> : null}
                      <td style={{ padding:"8px 12px", color:"rgba(255,255,255,0.6)" }}>{row.p}</td>
                      <td style={{ padding:"8px 12px", color:"rgba(255,255,255,0.4)" }}>{row.base}</td>
                      <td style={{ padding:"8px 12px", fontWeight:600, color:row.changed?"#fff":"rgba(255,255,255,0.4)" }}>{row.eff}</td>
                      <td style={{ padding:"8px 12px" }}>
                        {row.changed ? <span style={{ color:config.color, fontSize:11 }}>
                          {row.pct != null ? "\u25BC "+row.pct+"%" : "\u26A0 OVERRIDE"}
                        </span> : <span style={{ color:"rgba(255,255,255,0.2)" }}>{"\u2014"}</span>}
                      </td>
                    </tr>
                  ));
                })}
              </tbody>
            </table>
          </div>
        </div>

        {/* Bottom Row */}
        <div style={{ display:"grid", gridTemplateColumns:"1fr 1fr", gap:20 }}>

          {/* Event Injector */}
          <div style={{ background:"rgba(255,255,255,0.02)", border:"1px solid rgba(255,255,255,0.06)",
            borderRadius:12, padding:24 }}>
            <div style={{ fontSize:9, letterSpacing:3, color:"rgba(255,255,255,0.35)", marginBottom:12 }}>
              INJECT THREAT EVENTS
            </div>
            <div style={{ display:"grid", gridTemplateColumns:"repeat(3, 1fr)", gap:6, marginBottom:16 }}>
              {EVENT_KINDS.map(ek => (
                <button key={ek.kind} onClick={() => injectEvent(ek.kind, ek.severity)} style={{
                  padding:"8px 6px", fontSize:9, fontWeight:500, letterSpacing:0.5,
                  background:"rgba(255,255,255,0.03)", border:"1px solid rgba(255,255,255,0.08)",
                  color:"rgba(255,255,255,0.7)", borderRadius:6, cursor:"pointer",
                  display:"flex", flexDirection:"column", alignItems:"center", gap:4, transition:"all 0.2s ease",
                }}>
                  <span style={{ fontSize:16 }}>{ek.icon}</span>
                  <span>{ek.label}</span>
                  <span style={{ color:"rgba(255,255,255,0.3)" }}>sev: {ek.severity}</span>
                </button>
              ))}
            </div>
            <div style={{ fontSize:9, letterSpacing:3, color:"rgba(255,255,255,0.35)", marginBottom:8 }}>
              EVENT FEED ({events.length})
            </div>
            <div style={{ maxHeight:200, overflowY:"auto" }}>
              {events.length === 0 ? (
                <div style={{ color:"rgba(255,255,255,0.15)", fontSize:11, textAlign:"center", padding:24 }}>
                  No events. Click above to inject threats.
                </div>
              ) : events.map(ev => (
                <div key={ev.id} style={{ padding:"6px 10px", marginBottom:3, borderRadius:4,
                  background:"rgba(255,255,255,0.02)", borderLeft:"2px solid "+config.color+"40",
                  display:"flex", justifyContent:"space-between", alignItems:"center",
                  animation:"fadeSlideIn 0.3s ease", fontSize:11 }}>
                  <span>
                    <span style={{ marginRight:6 }}>{ev.icon}</span>
                    <span style={{ color:"rgba(255,255,255,0.7)" }}>{ev.label}</span>
                    {ev.resultLevel && <span style={{ marginLeft:8, color:config.color, fontSize:10 }}>{"\u2192"} {ev.resultLevel}</span>}
                  </span>
                  <span style={{ color:"rgba(255,255,255,0.25)", fontSize:10 }}>{ev.time}</span>
                </div>
              ))}
            </div>
          </div>

          {/* Key Inventory */}
          <div style={{ background:"rgba(255,255,255,0.02)", border:"1px solid rgba(255,255,255,0.06)",
            borderRadius:12, padding:24 }}>
            <div style={{ display:"flex", justifyContent:"space-between", alignItems:"center", marginBottom:12 }}>
              <div style={{ fontSize:9, letterSpacing:3, color:"rgba(255,255,255,0.35)" }}>
                KEY INVENTORY ({keys.length})
              </div>
              <button onClick={generateKey} style={{ padding:"4px 10px", fontSize:9, fontWeight:600, letterSpacing:1,
                background:"rgba(59,130,246,0.1)", border:"1px solid rgba(59,130,246,0.3)",
                color:"#3b82f6", borderRadius:4, cursor:"pointer" }}>+ NEW DEK</button>
            </div>
            <div style={{ maxHeight:380, overflowY:"auto" }}>
              {keys.map(k => (
                <div key={k.id} style={{ padding:"10px 12px", marginBottom:4, borderRadius:6,
                  background:"rgba(255,255,255,0.02)", border:"1px solid rgba(255,255,255,0.04)",
                  display:"grid", gridTemplateColumns:"1fr auto auto auto auto", alignItems:"center", gap:10, fontSize:11 }}>
                  <div>
                    <div style={{ fontWeight:600, color:"#fff", fontSize:12 }}>{k.name}</div>
                    <div style={{ color:"rgba(255,255,255,0.35)", fontSize:10, marginTop:2 }}>
                      {k.key_type} {"\u00B7"} v{k.version} {"\u00B7"} {k.id.slice(0,12)}
                    </div>
                  </div>
                  <div style={{ textAlign:"right" }}>
                    <div style={{ color:"rgba(255,255,255,0.4)", fontSize:10 }}>usage</div>
                    <div style={{ fontWeight:600, color:"rgba(255,255,255,0.7)" }}>{k.usage_count}</div>
                  </div>
                  <div style={{ padding:"3px 8px", borderRadius:3, fontSize:9, fontWeight:600, letterSpacing:1,
                    background:stateColor(k.state)+"15", color:stateColor(k.state),
                    border:"1px solid "+stateColor(k.state)+"25", minWidth:65, textAlign:"center" }}>
                    {k.state.toUpperCase()}
                  </div>
                  {k.state === "Active" ? (
                    <button onClick={() => rotateKey(k.id)} style={{ padding:"3px 8px", borderRadius:3, fontSize:9, fontWeight:600,
                      background:"rgba(234,179,8,0.1)", border:"1px solid rgba(234,179,8,0.3)",
                      color:"#eab308", cursor:"pointer", letterSpacing:1 }}>{"\u21BB"} ROTATE</button>
                  ) : <div style={{ minWidth:65 }} />}
                  <div style={{ color:"rgba(255,255,255,0.2)", fontSize:10, minWidth:70, textAlign:"right" }}>
                    {new Date(k.created_at).toLocaleDateString()}
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>

        </>)}

        {/* Footer */}
        <div style={{ marginTop:20, padding:"12px 0", borderTop:"1px solid rgba(255,255,255,0.04)",
          display:"flex", justifyContent:"space-between", alignItems:"center", fontSize:10, color:"rgba(255,255,255,0.2)" }}>
          <span>citadel-api v0.2.0 {"\u00B7"} citadel-keystore v0.1.0 {"\u00B7"} citadel-envelope v0.1.0</span>
          <span>HYBRID POST-QUANTUM {"\u00B7"} FIPS 203 ML-KEM-768</span>
        </div>
      </div>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<CitadelDashboard />);
</script>
</body>
</html>
